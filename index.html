<script src="https://unpkg.com/testml-compiler/lib/testml-compiler/browser.js"></script>
<script src="../testml-compiler/npm/lib/testml-compiler/browser.js"></script>

<script src="https://unpkg.com/testml/lib/testml/browser.js"></script>
<script src="node/npm/lib/testml/browser.js"></script>

<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://coffeescript.org/v2/browser-compiler/coffeescript.js"></script>
<script src="https://unpkg.com/lodash/lodash.min.js"></script>

<h2>TestML Interactive Demo</h2>
<div id="nav">
<!-- select id="yaml" onchange="setYAMLTest(this.value)"><option>YAML Test Suite</option></select -->
</div>

<textarea id="testml"></textarea>
<textarea id="bridge"></textarea>
<textarea id="output" readonly="true"></textarea>
<br>
<div id="explanation">
This is an interactive demo for running TestML programs in JavaScript.<br><br>

In the first box, you enter some TestML and in the next box you enter your
TestML Bridge Class written in CoffeeScript. Your tests will automatically be
run and the results will shown on the right.<br><br>

<a href="https://github.com/testml-lang/testml">Fork me on GitHub</a><br><br>

Check out the <a href="https://testml-lang.github.io/testml-compiler/">TestML Compiler</a>!<br><br>
</div>


<script>
sample_testml = `\
#!/usr/bin/env testml

*a.add(*b) == *c
*b.add(*a) == *c
*c.sub(*a) == *b
*c.sub(*b) == *a

=== Test 1
--- a: 1
--- b: 2
--- c: 3

=== Test 2
--- a: 4
--- b: 5
--- c: 9
`
sample_bridge = `\
class TestMLBridge extends TestML.Bridge
  add: (x, y)->
    Number(x) + Number(y)

  sub: (x, y)->
    x - y
`

function runTestML() {
  var input = $('#testml')[0].value
  var coffee = $('#bridge')[0].value
  var output = $('#output')[0]
  var testml, bridge, runner

  output.value = ''

  try {
    testml = JSON.parse((new TestMLCompiler.Compiler).compile(input))
  }
  catch(e) {
    output.value = String(e)
    throw e
  }

  try {
    eval(CoffeeScript.compile(coffee, {bare: true}))
    bridge = new TestMLBridge
  }
  catch(e) {
    output.value = String(e)
    throw e
  }

  try {
    runner = new TestML.Run.TAP(testml, bridge)
    runner.test()
  }
  catch(e) {
    output.value = String(e)
    throw e
  }

  output.value = runner.tap.output
}

$('#testml')[0].value = sample_testml
$('#bridge')[0].value = sample_bridge
runTestML()
$('#testml').on('keyup', _.debounce(runTestML, 333))
$('#bridge').on('keyup', _.debounce(runTestML, 333))
</script>


<style>
body {
  font-family: sans-serif;
}
#nav {
  width: 100%;
  padding-bottom: 5px;
}
textarea {
  font-family: monospace;
  width: 500px;
  height: 500px;
}
#explanation {
  padding-top: 15px;
  width: 500px;
}
</style>
