#!/bin/bash

# shellcheck disable=SC1090,2034

set -e

[[ -n $TESTML_SOURCED ]] ||
  source "${TESTML_ROOT:-$(dirname "$0")/..}/bin/testml"

export TESTML_LANG=${TESTML_LANG:-coffee}

testml-run-file() {
  local testml_run_file=$1

  export TESTML_RUN=${TESTML_RUN:-testml/run/mocha}
  export TESTML_LIB=${TESTML_LIB:-$TESTML_ROOT/lib/coffee}
  export TESTML_BRIDGE=${TESTML_BRIDGE:-testml-bridge}
  export TESTML_PATH=${TESTML_PATH:-$TESTML_INPUT_DIR}

  # shellcheck disable=SC2154
  NODE_PATH="$TESTML_LIB:$TESTML_PATH" \
    "$TESTML_LANG" \
      -e "require('$TESTML_RUN').run('$testml_run_file')"
}

TESTML_LANG_SOURCED=1

[[ $0 != "${BASH_SOURCE[0]}" ]] || testml-run "$@"
